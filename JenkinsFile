pipeline{
    agent { label "master" }

    environment { 
        ECR_REGISTRY = "744261147378.dkr.ecr.us-east-1.amazonaws.com/"
        APP_REPO_NAME = "fatma-repo/phonebook-app"
        AWS_REGION = "us-east-1"
    }

    stages {
        stage("Create ECR Repo") {
            steps {
            echo "Creating ECR Repository"
            sh """
                aws ecr create-repository \
                  --repository-name ${APP_REPO_NAME} \
                  --image-scanning-configuration scanOnPush=false \
                  --image-tag-mutability MUTABLE \
                  --region ${AWS_REGION}
                """
            }
        }
        stage("Build APP Docker Images"){
            steps {
                echo "Building App Docker images"
            }
        }
        stage("Push APP Docker Images to ECR"){
            steps {
                echo "Pushing images to ECR"
            }
        }
        stage("Create Infrastructure"){
            steps {
                echo "Testing if Dcker Swarm is ready or not"
            }
        }
        stage("Deploy the App on Docker Swarm"){
            step {
                echo "DEploying the app"
            }
        }
        stage("Test the application"){
            steps { 
                echo "Check if the application is ready or not"
            }
        }
    }
    post {
        always{
            echo "Deleting all local images"
        }
        failure {
            echo "Deleting the image repository on ECR due to failure""
            echo "Deleting the cloudformation steck due to failure"
        }
    }
}